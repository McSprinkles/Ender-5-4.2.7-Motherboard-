# This file contains pin mappings for the Creality Ender 5 Plus.
# This config is for Ender 5 Plus with upgraded 4.2.7 (NOT 4.2.2) mainboard.

# Modified by rootkitxx@gma as there were no usable 4.2.7 profiles for E5+ I could find.
# NOTE: This configuration is for split BlTouch Cable, FIRST 3 wire connector goes to 4.2.7 BLTouch port 
# (WARNING, make sure you change the wires around in the connector if you come from 1.X-2.X boards or you will FRY
# the 4.2.7 motherboard, look for 4.2.7 upgrade video on youtube, guy explains all the wiring fixes there. 
# SECOND (b/w) wire goes to z-stop port (as with the old motherboard) but wires will need to be switched around in the connector.
# If your BLTouch has single 5 pin cable that you plugged in to 4.2.7 BLT Sensor Port, you will need to use PA1 for BLTouch sensor pin.

# To use this config, during "make menuconfig" select the STM32F103 with
# a "28KiB bootloader" and serial (on USART1 PA10/PA9) communication.

# If you prefer a direct serial connection, in "make menuconfig"
# select "Enable extra low-level configuration options" and select
# serial (on USART3 PB11/PB10), which is broken out on the 10 pin IDC
# cable used for the LCD module as follows:
# 3: Tx, 4: Rx, 9: GND, 10: VCC

# Flash this firmware by copying "out/klipper.bin" to a SD card and
# turning on the printer with the card inserted. The firmware
# filename must end in ".bin" and must not match the last filename
# that was flashed.

# See docs/Config_Reference.md for a description of parameters.

# If you run Mainsail, then
[include mainsail.cfg]

# Uncomment when Fly Adxl345 is connected again
#[mcu adxl]
#serial: /dev/serial/by-id/usb-Klipper_rp2040_E66368254F7B5C21-if00
### To find the USB firmware ID, run: ls -l /dev/serial/by-id/
### Replace /dev/serial/by-id/usb-Klipper_rp2040_XXXXXXXXXXXXXXXXXXXXX with the ID you find

## ADXL345 Accelerometer
#[adxl345]
#cs_pin: adxl:gpio9
#spi_software_sclk_pin: adxl:gpio10
#spi_software_mosi_pin: adxl:gpio11
#spi_software_miso_pin: adxl:gpio12

#[resonance_tester]
#accel_chip: adxl345
#probe_points:
#   180, 180, 10  # This coordinate is where you want to measure, usually the center of the heated bed

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: 350
position_max: 350
homing_speed: 100

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: 350
position_max: 350
homing_speed: 100

[stepper_z]
step_pin: PB5
dir_pin: PB6
enable_pin: !PC3
microsteps: 16
rotation_distance: 4
endstop_pin: probe:z_virtual_endstop
position_max: 400
position_min: -5
homing_speed: 10.0

[endstop_phase]

[extruder]
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
rotation_distance: 33.683
nozzle_diameter: 1.0										# NOTE 1.0 Nozzle
filament_diameter: 1.750
pressure_advance: 0.9 										# This option wasn't in the original config
#pressure_advance_smooth_time: 0.010						# This option wasn't in the original config, for direct drive extruders
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
control: pid
pid_Kp: 22.2
pid_Ki: 1.08
pid_Kd: 114
min_temp: 0
max_temp: 260

[safe_z_home]
home_xy_position: 180, 180
speed: 100	
z_hop: 10													# Move up 10mm, so the probe doesnt hit anything 	
z_hop_speed: 5

[bltouch]
sensor_pin: PA7
control_pin: PB0
x_offset: -45
y_offset: -8
#z_offset: 0
speed: 3.0
samples: 1													# This option wasn't in the original config
pin_up_reports_not_triggered: True							# This option wasn't in the original config
pin_up_touch_mode_reports_triggered: False
#probe_with_touch_mode: True

#Wasn't in the original config
[screws_tilt_adjust]
screw1: 48,54
screw1_name: front left screw
screw2: 332,54
screw2_name: front right screw
screw3: 332,315
screw3_name: rear right screw
screw4: 48,315
screw4_name: rear left screw
horizontal_move_z: 10.
speed: 50.
screw_thread: CCW-M4

[bed_screws]
screw1: 26,39
screw2: 310,39
screw3: 310,300
screw4: 26,300

#new bed mesh code + gcode macro
[bed_mesh]
speed: 100
horizontal_move_z: 8
mesh_min: 50, 50
mesh_max: 300,300
probe_count: 5,5 # 3,3 or 5,5
mesh_pps: 2,2
algorithm: bicubic
bicubic_tension: 0.2
move_check_distance: 5
split_delta_z: .025
fade_start: 1
fade_end: 10
fade_target: 0

#[gcode_macro G29]
#gcode: 
#  G28
#  BED_MESH_CALIBRATE
#  BED_MESH_PROFILE SAVE=p1
#  G1 X0 Y0 Z5 F4000

# original bed mesh code
#[bed_mesh]
#speed: 100
#horizontal_move_z: 8
#mesh_min: 50, 50
#mesh_max: 300, 300
#probe_count: 3, 3

[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
control: pid
pid_Kp: 690.34
pid_Ki: 111.47
pid_Kd: 1068.83
min_temp: 0
max_temp: 130

[fan]
pin: PA0

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command										# This option wasn't in the original config

#Once sensor triggers there is macro that runs the filament the length of bowden tube before pause 
[filament_switch_sensor filament_sensor]
pause_on_runout: False
runout_gcode: PAUSE_AFTER_D D=70                            # Call your custom macro
switch_pin: PA4                                             # Use ! for inverted logic if needed

[printer]
kinematics: cartesian
max_velocity: 600											# Original was 300
max_accel: 5000												# Original was 2500
#max_accel_to_decel:5000									# This option wasn't in the original config
max_z_velocity: 15								            # Original was 5, 20 and 25 are too much
max_z_accel: 100
square_corner_velocity:5.0 									# This option wasn't in the original config

[input_shaper]
shaper_freq_x:90.9
shaper_freq_y:90.9
shaper_type: mzv

[gcode_macro PAUSE_AFTER_D]
description: Trigger to pause the print after a further 'd' mm has been extruded
variable_end_d: 0 #create variable "END_D" which is associated with the PAUSE_AFTER_D gcode macro
gcode:
  {% set d_start = printer.print_stats.filament_used|float %} #starting point is whatever the filament used is when PAUSE_AFTER_D is called
  {% set d_end = (d_start + params.D|float)|float %} #end point is start + D parameter
  SET_GCODE_VARIABLE MACRO=PAUSE_AFTER_D VARIABLE=end_d VALUE={d_end} #write the end value to the END_D gcode variable to access later
  M117 Pause at {printer["gcode_macro PAUSE_AFTER_D"].end_d|round(2)}
  UPDATE_DELAYED_GCODE ID=PAUSE_AT_D DURATION=1 #trigger the delayed gcode below after 1 second

[delayed_gcode PAUSE_AT_D]
initial_duration: 0 #if initial_duration is zero, the delayed gcode won't start by default
gcode:
  {% set d_current = printer.print_stats.filament_used|float %} #get the current filament used
  {% if d_current < printer["gcode_macro PAUSE_AFTER_D"].end_d %} #if we aren't at the stopping point
    M117 Stopping {d_current|round(2)} {printer["gcode_macro PAUSE_AFTER_D"].end_d|round(2)}
    UPDATE_DELAYED_GCODE ID=PAUSE_AT_D DURATION=1 #restart the timer on the delayed gcode
  {% else %}
    PAUSE
    # Move to a safe position
    G90
    G0 X340 Y340 Z10 F3000
    M117 Filament runout detected!                      # Add a custom message for the user
    M600   
    UPDATE_DELAYED_GCODE ID=PAUSE_AT_D DURATION=0 #set the delayed gcode duration back to zero so it doesn't keep triggering
  {% endif %}

#Bed Mesh Profile load (wasn't in the original config)
#[gcode_macro load_mesh]
#gcode:
# BED_MESH_PROFILE load=default

[board_pins]
aliases:
  EXP1_1=PC6,EXP1_3=PB10,EXP1_5=PB14,EXP1_7=PB12,EXP1_9=<GND>,
  EXP1_2=PB2,EXP1_4=PB11,EXP1_6=PB13,EXP1_8=PB15,EXP1_10=<5V>,
  PROBE_IN=PB0,PROBE_OUT=PB1,FIL_RUNOUT=PA4

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bltouch]
#*# z_offset = 2.45
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.158750, -0.126250, -0.030000, 0.041250, 0.043750
#*# 	  -0.117500, -0.050000, 0.086250, 0.138750, 0.101250
#*# 	  -0.111250, -0.047500, 0.058750, 0.110000, 0.142500
#*# 	  -0.132500, -0.078750, 0.020000, 0.052500, 0.091250
#*# 	  -0.170000, -0.166250, -0.098750, -0.030000, 0.050000
#*# x_count = 5
#*# y_count = 5
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 50.0
#*# max_x = 300.0
#*# min_y = 50.0
#*# max_y = 300.0
